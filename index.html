<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>URL编辑器</title>
    <script src="https://cdn.jsdelivr.net/npm/urijs@1.19.11/src/URI.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background-color: #f4f4f4;
      }
      .card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        padding: 20px;
        margin-bottom: 20px;
      }
      .input-group,
      .query-group,
      .output-group {
        display: flex;
        align-items: center;
        margin: 6px 0;
      }
      .input-group input[type="text"],
      .output-group input[type="text"],
      .query-group input[type="text"] {
        flex: 1;
        padding: 5px;
      }
      .query-group label {
        margin-right: 10px;
      }
      input[type="text"] {
        width: calc(100% - 60px);
        padding: 5px;
        margin-right: 10px;
        display: inline-block;
      }
      button {
        padding: 10px 20px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        border-radius: 4px;
      }
      button:hover {
        background-color: #45a049;
      }
      .copy-button {
        padding: 5px 10px;
        background-color: #4caf50;
        color: white;
        border: none;
        cursor: pointer;
        margin-left: 10px;
        border-radius: 4px;
        display: inline-block;
      }
      .copy-button:hover {
        background-color: #45a049;
      }
      #qrcode {
        margin: 10px;
      }
    </style>
  </head>
  <body>
    <h1>URL编辑器</h1>

    <div class="card">
      <h2>输入URL</h2>
      <div class="input-group">
        <input type="text" id="inputUrl" name="inputUrl" value="" />
        <button
          type="button"
          class="copy-button"
          onclick="copyToClipboard('inputUrl')"
        >
          复制
        </button>
        <button
          type="button"
          class="copy-button"
          onclick="openInNewTab('inputUrl')"
        >
          新标签页打开
        </button>
      </div>
      <button type="button" onclick="parseUrl()">解析URL</button>
    </div>

    <div class="card">
      <h2>调整参数</h2>
      <form id="queryForm"></form>
      <button type="button" onclick="addCustomParam()">添加新的参数</button>
    </div>

    <div class="card">
      <h2>输出结果</h2>
      <button type="button" onclick="updateUrl()">更新URL</button>
      <div class="output-group">
        <input type="text" id="outputUrl" readonly />
        <button
          type="button"
          class="copy-button"
          onclick="copyToClipboard('outputUrl')"
        >
          复制
        </button>
        <button
          type="button"
          class="copy-button"
          onclick="openInNewTab('outputUrl')"
        >
          新标签页打开
        </button>
      </div>
      <div id="qrcode"></div>
    </div>

    <script>
      function parseUrl() {
        const urlString = document.getElementById("inputUrl").value;
        const uri = new URI(urlString);
        const query = uri.query(true);
        const form = document.getElementById("queryForm");
        form.innerHTML = "";

        // 根据已存在的参数生成输入
        Object.keys(query).forEach((key) => {
          const formGroup = document.createElement("div");
          formGroup.className = "query-group";
          formGroup.setAttribute("data-param", key);

          const label = document.createElement("label");
          label.setAttribute("for", key);
          label.textContent = key.charAt(0).toUpperCase() + key.slice(1) + ":";

          const input = document.createElement("input");
          input.type = "text";
          input.id = key;
          input.name = key;
          input.value = query[key];

          const copyButton = document.createElement("button");
          copyButton.type = "button";
          copyButton.className = "copy-button";
          copyButton.textContent = "复制";
          copyButton.onclick = () => copyToClipboard(key);

          formGroup.appendChild(label);
          formGroup.appendChild(input);
          formGroup.appendChild(copyButton);
          form.appendChild(formGroup);
        });
      }

      function addCustomParam() {
        const form = document.getElementById("queryForm");
        const formGroup = document.createElement("div");
        formGroup.className = "query-group";
        formGroup.setAttribute("data-param", "");

        const label = document.createElement("label");
        label.textContent = "自定义参数:";

        const keyInput = document.createElement("input");
        keyInput.type = "text";
        keyInput.placeholder = "key";

        const valueInput = document.createElement("input");
        valueInput.type = "text";
        valueInput.placeholder = "value";

        formGroup.appendChild(label);
        formGroup.appendChild(keyInput);
        formGroup.appendChild(valueInput);
        form.appendChild(formGroup);
      }

      function updateUrl() {
        const urlString = document.getElementById("inputUrl").value;
        const uri = new URI(urlString);
        const formGroups = document.querySelectorAll("#queryForm .query-group");
        const updatedQuery = {};

        // 处理已有及自定义参数
        formGroups.forEach((group) => {
          const paramKey = group.getAttribute("data-param");
          if (paramKey) {
            const input = group.querySelector("input[name='" + paramKey + "']");
            if (input) updatedQuery[paramKey] = input.value;
          } else {
            const inputs = group.querySelectorAll("input");
            const key = inputs[0].value.trim();
            const val = inputs[1].value.trim();
            if (key) updatedQuery[key] = val;
          }
        });

        const updatedUri = uri.query(updatedQuery).toString();
        document.getElementById("outputUrl").value = updatedUri;
        generateQRCode();
      }

      function copyToClipboard(elementId) {
        const copyText =
          document.getElementById(elementId).value ||
          document.getElementById(elementId).textContent;
        const textarea = document.createElement("textarea");
        textarea.value = copyText;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand("copy");
        document.body.removeChild(textarea);
        alert("已复制到剪贴板");
      }

      function openInNewTab(elementId) {
        const url = document.getElementById(elementId).value;
        if (url) {
          window.open(url, "_blank");
        } else {
          alert("URL为空，无法打开新标签页");
        }
      }

      function generateQRCode() {
        const outputUrl = document.getElementById("outputUrl").value;
        const qrcodeContainer = document.getElementById("qrcode");
        qrcodeContainer.innerHTML = "";
        new QRCode(qrcodeContainer, {
          text: outputUrl,
          height: 512,
          width: 512
        });
      }
    </script>
  </body>
</html>